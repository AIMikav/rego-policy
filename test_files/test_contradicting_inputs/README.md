# Contradicting Test Inputs for Rego Policies

This directory contains contradicting test input JSON files for all 53 Rego policies in the project. Each policy has two test cases:

- **Pass case**: A test input that should **NOT** trigger any policy violations (follows the rules)
- **Fail case**: A test input that **SHOULD** trigger policy violations (violates the rules)

## Directory Structure

```
test_contradicting_inputs/
├── pass/           # Test cases that should PASS (no violations)
│   ├── policy_0_pass.json
│   ├── policy_1_pass.json
│   └── ... (53 files total)
├── fail/           # Test cases that should FAIL (violations detected)
│   ├── policy_0_fail.json
│   ├── policy_1_fail.json
│   └── ... (53 files total)
└── README.md       # This file
```

## Policy Categories

The test cases are generated for different types of policies:

### 1. Container Image Policies
- **Policy 4**: `container_image_latest` - Prevents using `:latest` image tags
  - **Pass**: Uses specific version tags (e.g., `v1.2.3`)
  - **Fail**: Uses `:latest` tag

### 2. Namespace Security Policies
- **Policy 0**: `namespace_has_networkpolicy` - Requires NetworkPolicy for namespaces
  - **Pass**: Namespace with NetworkPolicy
  - **Fail**: Namespace without NetworkPolicy

- **Policy 1**: `namespace_has_resourcequota` - Requires ResourceQuota for namespaces
  - **Pass**: Namespace with ResourceQuota
  - **Fail**: Namespace without ResourceQuota

### 3. Kubernetes Labels Policies
- **Policy 2**: `common_k8s_labels_notset` - Requires standard Kubernetes labels
  - **Pass**: Pod with all required labels (`app.kubernetes.io/*`)
  - **Fail**: Pod without required labels

### 4. Container Environment Policies
- **Policy 3**: `container_env_maxmemory_notset` - Requires CONTAINER_MAX_MEMORY for Java containers
  - **Pass**: Java container with CONTAINER_MAX_MEMORY environment variable
  - **Fail**: Java container without CONTAINER_MAX_MEMORY environment variable

## Usage Examples

### Testing a Single Policy

```bash
# Test policy_4 with pass case (should have no violations)
opa eval --data data/policy_4.rego \
         --data lib/konstraint/core/src.rego \
         --data lib/openshift/src.rego \
         --input test_contradicting_inputs/pass/policy_4_pass.json \
         'data.ocp.bestpractices.container_image_latest.violation'

# Test policy_4 with fail case (should have violations)
opa eval --data data/policy_4.rego \
         --data lib/konstraint/core/src.rego \
         --data lib/openshift/src.rego \
         --input test_contradicting_inputs/fail/policy_4_fail.json \
         'data.ocp.bestpractices.container_image_latest.violation'
```

### Running the Test Script

```bash
# Run the comprehensive test script
./test_contradicting_policies.sh
```

## Expected Results

### Pass Cases
- Should return an empty result `[]` (no violations)
- Indicates the test input follows the policy rules

### Fail Cases
- Should return violation messages
- Indicates the test input violates the policy rules

## Test Case Generation

The test cases are generated by the `generate_contradicting_tests.py` script, which:

1. Analyzes each Rego policy file
2. Extracts violation conditions and requirements
3. Generates appropriate Kubernetes resource manifests
4. Creates both passing and failing scenarios
5. Saves the results in organized JSON files

## File Naming Convention

- `policy_X_pass.json`: Test case that should pass (no violations)
- `policy_X_fail.json`: Test case that should fail (violations detected)

Where `X` is the policy number (0-52).

## Dependencies

To run these tests, you need:

- Open Policy Agent (OPA) installed
- Access to the policy files in the `data/` directory
- Access to the library files in the `lib/` directory

## Notes

- Some policies may require specific library imports (konstraint, openshift, etc.)
- The test cases are designed to be realistic Kubernetes resource manifests
- Each test case focuses on the specific policy being tested
- The generated test cases cover the most common violation scenarios for each policy type
